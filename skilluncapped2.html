<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SkillUncapped</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
  
    input[type="text"],
    button {
      background-color: #2b2b2b;
      color: white;
      border: none;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
  
    button {
      cursor: pointer;
      margin-right: 10px;
    }
  
    button:hover {
      background-color: #3a3a3a;
    }
  
    p {
      color: #aaa;
    }
  
    #status {
      color: #ccc;
      margin-top: 20px;
    }
  
    video {
      display: block;
      margin-top: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
  
    .input-wrapper {
      width: 34%;
    }
  
    .input-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
  
    .input-container label {
      width: 60px;
      margin-right: 10px;
      flex-shrink: 0;
    }
  
    .input-container input {
      flex-grow: 1;
      width: 100%;
    }
  </style>
  </head>
  <label>Link: </label>
  <div class="input-wrapper">
    <div class="input-container">
      <label for="url">URL:</label>
      <input onkeyup="if (event.key =='Enter') stream()" id="url" placeholder="Link" />
    </div>
    <br>
    <div class="input-container">
      <label for="fileNameInput">Name:</label>
      <input id="fileNameInput" />
    </div>
  </div>
  <button style="width: 80px; background-color: cadetblue;" onclick="stream()">Stream</button>
  <button style="width: 80px; background-color: darkseagreen;" onclick="downloadVideo()">Download</button>
<label style="display: block;" id="status"></label>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
<video style="display: block; margin-top: 10px;" height="720" width="1280" id="video" controls autoplay
  crossorigin="anonymous" />
<script>
  var hls = null;

  if (Hls.isSupported()) {
    var hlsjsConfig = {
      "maxBufferSize": 0,
      "maxBufferLength": 30,
      "startPosition": 0
    }
    hls = new Hls(hlsjsConfig);
    hls.on(Hls.Events.MANIFEST_PARSED, function () {
      video.play();
    });
  }

  const rgx = /([a-z0-9]{10})(:?\/|$)/g;

  async function stream() {
    if (hls == null) {
      alert("hls not supported, please use a modern browser such as Chrome");
      return;
    }
    let rawUrl = document.getElementById("url").value;
    let ids = [];
    let match = null;

    while (match = rgx.exec(rawUrl)) {
      ids.push(match[1]);
    }

    if (ids.length < 1) {
      alert("invalid url");
      return;
    }

    let videoId;

    if (rawUrl.includes("browse/course")) {
      // If the URL is a "Course" link, remove the last part and the trailing slash
      rawUrl = rawUrl.slice(0, rawUrl.lastIndexOf("/"));
      videoId = ids[ids.length - 2];
    } else {
      videoId = rawUrl.includes("browse3") ? ids[0] : ids[ids.length - 1];
    }

    let statusLabel = document.getElementById("status");

    console.log(`video id is ${videoId}`);
    console.log("looking for final part...");

    let last = 0;

    let jump = true;

    for (let i = 300; i <= 1000; i++) {
      if (i == 1000) {
        alert("error finding last part");
        return;
      }
      if (i == 0) i = 1;
      const url = `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-${String(i).padStart(5, "0")}.ts`;

      console.log(`testing ${url}`);

      statusLabel.innerText = `Looking for final part ; Testing ${i}...`;
      try {
        const resp = await fetch(url, { method: 'HEAD' });
        if (resp.status === 403) {
          if (i >= 50 && i % 50 == 0 && jump) {
            last = i;
            jump = true;
            i -= 51;
            continue;
          }
          break;
        }
        last = i;
        jump = false;
      } catch (e) {
        alert("fetch failed, please install a Cross-Origin disabler extension for your browser or check your internet connectivity.");
        return;
      }
    }

    statusLabel.innerText = "";
    let data = "#EXTM3U\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:10";

    for (let i = 0; i <= last; i++) {
      data += `#EXTINF:10,\nhttps://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-${String(i).padStart(5, "0")}.ts\n`
    }
    console.log(data);
    hls.loadSource(
      "data:application/x-mpegURL;base64," + btoa(data)
    );
    hls.attachMedia(video);
  }

  async function downloadVideo() {
  let rawUrl = document.getElementById("url").value;
  let enteredFileName = document.getElementById("fileNameInput").value;
  let ids = [];
  let match = null;

  while (match = rgx.exec(rawUrl)) {
    ids.push(match[1]);
  }

  if (ids.length < 1) {
    alert("Invalid URL");
    return;
  }

  let videoId;

  if (rawUrl.includes("browse/course")) {
    // If the URL is a "Course" link, remove the last part and the trailing slash
    rawUrl = rawUrl.slice(0, rawUrl.lastIndexOf("/"));
    videoId = ids[ids.length - 2]; // Use the second-to-last ID as the video ID
  } else {
    videoId = rawUrl.includes("browse3") ? ids[0] : ids[ids.length - 1];
  }

  let statusLabel = document.getElementById("status");

  console.log(`Video ID is ${videoId}`);
  console.log("Looking for final part...");
  let last = 0;
  let jump = true;

  for (let i = 300; i <= 1000; i++) {
    if (i == 1000) {
      alert("error finding last part");
      return;
    }

    if (i == 0) i = 1;

    const url = `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-${String(i).padStart(5, "0")}.ts`;
    console.log(`testing ${url}`);
    statusLabel.innerText = `Looking for final part ; Testing ${i}...`;
    try {
      const resp = await fetch(url, { method: 'HEAD' });
      if (resp.status === 403) {
        if (i >= 50 && i % 50 == 0 && jump) {
          last = i;
          jump = true;
          i -= 51;
          continue;
        }
        break;
      }
      last = i;
      jump = false;
    } catch (e) {
      alert("fetch failed, please install a Cross-Origin disabler extension for your browser or check your internet connectivity.");
      return;
    }
  }

  statusLabel.innerText = "";
  statusLabel.innerText = `Total parts to download: ${last + 1}`;

  const downloadLink = document.createElement("a");
  downloadLink.href = `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-00000.ts`;
  downloadLink.download = `${enteredFileName}.ts`;
  downloadLink.style.display = "none";
  document.body.appendChild(downloadLink);

  for (let i = 0; i <= last; i++) {
    const segmentUrl = `https://d13z5uuzt1wkbz.cloudfront.net/${videoId}/HIDDEN4500-${String(i).padStart(5, "0")}.ts`;
    try {
      const response = await fetch(segmentUrl);
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      downloadLink.href = blobUrl;
      downloadLink.download = `${enteredFileName}-${String(i).padStart(5, "0")}.ts`;
      downloadLink.click();
      window.URL.revokeObjectURL(blobUrl);
      statusLabel.innerText = `Downloading part ${i + 1} of ${last + 1}`;
    } catch (error) {
      console.error(`Failed to download segment ${i}:`, error);
    }
  }

  statusLabel.innerText = "Download complete";
  document.body.removeChild(downloadLink);
}

</script>



</body>

</html>